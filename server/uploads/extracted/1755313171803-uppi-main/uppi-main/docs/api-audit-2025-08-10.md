# API Audit Report

Date: 2025-08-10

Summary: Comprehensive audit of internal and external APIs using current logs, network traces, and code inspection. Below are detected issues and a remediation plan to bring all endpoints and data flows up to date.

---

## Detected Issues (from logs and traces)

1) Edge Function: check-api-keys
- Error: "Invalid encrypted API key format: Failed to decode base64" when testing Perplexity key
- Impact: Key validation fails for some providers due to mixed storage formats (masked/encrypted/plaintext)
- Source: edge-function-logs-check-api-keys

2) Edge Function: validate-api-key
- Error: "Provider and API key are required"
- Impact: Function is called without required body; missing validation and/or callers not sending payload
- Source: edge-function-logs-validate-api-key

3) Edge Function: microservice-health
- Errors: 404 for https://example.com and timeout
- Impact: Health monitor points to placeholder URLs; yields degraded/down status and noisy logs
- Source: edge-function-logs-microservice-health

4) Database RLS/Access Violations
- Errors: "permission denied for table api_keys", "admin_api_keys", and "system_components"
- Impact: Client code is directly querying restricted tables; should use RPC/Edge functions under RLS
- Source: postgres-logs

5) Admin UI (APIIntegrationMap) DB health check
- Probable Cause: Client-side select on admin_api_keys (restricted) used as DB liveness probe
- Impact: Triggers permission denied and false negatives in UI health
- Source: code inspection (previous version), matching postgres-logs errors

6) AI Validation Engine (historical)
- Error: Unauthorized to OpenAI observed in earlier logs
- Impact: Engine uses provider key that may not be fetched per-user, or relies on missing env secret
- Source: prior function logs (ai-validation-engine)

7) Build/Quality warnings
- Deprecated: import.meta.glob option "as" → replace with query: '?raw'
- Impact: Not breaking, but needs modernization for future compatibility
- Source: build output warnings

8) Data availability
- competitor_analyses: Multiple GETs returning [] for user; company_profiles has entries but analyses table empty
- Impact: Downstream report views appear empty; likely write path not saving analyses consistently
- Source: network-requests

9) Edge Function: admin-api-keys
- Error: "permission denied for table admin_api_keys"
- Impact: Function attempts to read a restricted table without service role or curated RPC; breaks Admin UI diagnostics
- Source: edge-function-logs-admin-api-keys

10) Edge Function: user-api-keys
- Error: AuthSessionMissingError (no browser session in function context)
- Impact: Function expects client session; must use request-based auth or verify_jwt; returns 400 and blocks key flows
- Source: edge-function-logs-user-api-keys

11) Edge Function: document-processing
- Error: AuthSessionMissingError
- Impact: Same pattern as user-api-keys; cannot derive user → operations fail
- Source: edge-function-logs-document-processing

12) Observability gaps (multiple functions)
- Error: Failed to fetch logs for some functions (e.g., ai-drill-down, comprehensive-competitor-analysis, analysis-export, get-function-url, etc.)
- Impact: Reduced visibility into failures; may indicate naming or deployment mismatches
- Source: edge-function-logs-<various> fetch failures

---

## Remediation Plan

A) Edge Functions: Key Management and Validation
1. Standardize decryption path across functions (check-api-keys, validate-api-key, ai-validation-engine):
   - Use RPC public.manage_api_key('get_for_decryption') to fetch raw key
   - Implement tolerant decryptIfNeeded (plaintext or legacy formats)
   - Validate prefix patterns per provider (openai sk-*, pplx-* etc.) and return actionable error messages
2. validate-api-key inputs:
   - Add strict input schema checks (provider, mode, optional user_id)
   - Accept either explicit key (admin-only) or fetch per-user via RPC; forbid unauthenticated usage
3. Logging & Metrics:
   - On failures, log to api_metrics/api_usage_costs with provider, endpoint, and error details (service role)

B) Database Access & RLS Compliance
1. Replace any client selects on admin_api_keys, api_keys, system_components with:
   - RPCs (SECURITY DEFINER) already present: manage_api_key, get_system_health_overview, exec_sql (curated)
   - Edge Functions for sensitive reads, using service role key
2. Verify RLS policies for all user-facing reads/writes; ensure all client operations include user_id and rely on policies
3. Add safe DB liveness probe:
   - Client should call rpc: debug_auth_context or select from a public/user-owned table instead of restricted tables

C) Microservice Health Monitor
1. Replace placeholder URLs with real services (or config-driven list)
2. Add graceful handling: treat 404/timeout as degraded with clear messages; avoid noisy logs
3. Persist last successful status and expose in Admin UI

D) Competitor Analysis Save Path
1. Ensure service saves analysis rows after edge orchestration completes (status=completed, analysis_data, costs)
2. Add withErrorHandling wrapper and retry on transient failures
3. Verify RLS insert path includes user_id; avoid violates RLS errors

E) Admin UI (APIIntegrationMap) Improvements
1. DB health check: swap restricted table probe for rpc: debug_auth_context or curated exec_sql summaries
2. Dynamic discovery already added; keep Issues Summary in Debug Report (done). Extend to include counts of degraded/down
3. Ensure all per-integration error modals include Copy for AI (done) and link to Supabase logs

F) AI Validation Engine
1. Switch to per-user provider key retrieval via manage_api_key
2. Remove reliance on global env keys for model providers (unless explicitly needed for admin-only ops)
3. Add clear error surfaced to UI with remediation tips

G) Build/Quality Hygiene
1. Search & replace import.meta.glob({ as: 'raw' }) → { query: '?raw', import: 'default' }
2. Add unit tests for edge function payload validation and decryption fallback (no any types)
3. Lint pass + types for Supabase responses (PostgrestResponse where applicable)

H) Test Plan & Verification
1. Unit tests: decryption, provider validation, RPC fallbacks
2. Integration tests: end-to-end competitor analysis run storing rows; admin debug report contains issues_summary
3. Manual checks: run health checks, open per-integration error modal, copy report for AI, confirm DB probe success

---

## Actionable Tasks Checklist

- [ ] Unify key decryption across Edge Functions (check-api-keys, validate-api-key, ai-validation-engine)
- [ ] Update validate-api-key to accept proper payload and/or fetch per-user keys via RPC
- [ ] Replace client reads of restricted tables with RPC or Edge Function calls
- [ ] Fix microservice-health URL sources and degrade gracefully
- [ ] Ensure competitor analysis persistence path writes to competitor_analyses with status completed
- [ ] Update Admin UI DB health probe to safe RPC; keep issues_summary in debug report (enhanced)
- [ ] Address import.meta.glob deprecated usage project-wide
- [ ] Add tests and type safety for Supabase responses

---

## Acceptance Criteria

- All API health checks report operational or provide clear degraded reasons without permission errors
- No client-side queries to restricted tables; all sensitive reads via RPC/Edge functions
- Key validation succeeds for supported providers; clear errors for misconfigured keys
- Competitor analyses saved and visible in UI
- Debug report includes issues_summary and is copyable for AI agents

---

Notes:
- This plan follows existing security posture (RLS enabled, SECURITY DEFINER RPCs) and avoids exposing secrets client-side
- Where admin-only visibility is needed, use service role in Edge Functions with proper logging
