# Development Dockerfile for Manito Application
FROM node:20-alpine

# Install system dependencies and development tools
RUN apk add --no-cache \
    git \
    curl \
    bash \
    vim \
    nano \
    htop \
    tree \
    jq \
    libc6-compat \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Install global development tools
RUN npm install -g \
    nodemon \
    concurrently \
    @vscode/vsce \
    eslint \
    prettier \
    typescript \
    ts-node

# Copy source code first to avoid postinstall script issues
COPY . .

# Install dependencies with legacy peer deps and development optimizations
RUN npm ci --legacy-peer-deps --include=dev --fund=false --audit=false

# Create development directories with proper permissions
RUN mkdir -p \
    /app/scan-workspace \
    /app/logs \
    /app/.cache \
    /app/coverage \
    /app/client/.vite \
    /tmp/manito-dev

# Create non-root user for development
RUN addgroup -g 1001 -S nodejs && \
    adduser -S manito -u 1001 -G nodejs

# Set permissions for development
RUN chown -R manito:nodejs /app /tmp/manito-dev

# Switch to non-root user
USER manito

# Set development environment variables
ENV NODE_ENV=development
ENV DEBUG=manito:*
ENV CHOKIDAR_USEPOLLING=true
ENV WATCHPACK_POLLING=true

# Expose dynamic ports for development (will be mapped at runtime)
EXPOSE 3000-3010 5173-5180 9229

# Health check for development with extended timeout
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=5 \
    CMD curl -f http://localhost:3000/api/health || exit 1

# Create startup script for development with dynamic port support
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Starting ManitoDebug Development Environment"\n\
echo "ðŸ“¦ Installing/updating dependencies..."\n\
npm install --legacy-peer-deps\n\
\n\
echo "ðŸ”§ Running development setup..."\n\
npm run postinstall\n\
\n\
echo "ðŸŒŸ Starting development servers with dynamic port management..."\n\
echo "   â€¢ Server: Dynamic port assignment (typically 3000)"\n\
echo "   â€¢ Client: Dynamic port assignment (typically 5173)"\n\
echo "   â€¢ Debugger: http://localhost:9229"\n\
echo "   â€¢ Port conflicts will be automatically resolved"\n\
echo ""\n\
exec npm run dev\n\
' > /app/start-dev.sh && chmod +x /app/start-dev.sh

# Default development command
CMD ["/app/start-dev.sh"]